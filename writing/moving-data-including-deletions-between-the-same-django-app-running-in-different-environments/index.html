<!doctypehtml><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0 name=viewport><title>Moving data including deletions between the same Django app running in different environments - Matthias Kestenholz</title><link href=/styles.d2047758144a.css rel=stylesheet><link title="Blog feed"href=/writing/atom.xml rel=alternate type=application/atom+xml><body><header><div class=wrappy><a class=title href=/>Hi, I'm Matthias</a><p class=subtitle>I am a founding partner of <a href=https://feinheit.ch>Feinheit AG</a> and <a href=https://diebruchpiloten.com>Die Bruchpiloten AG</a>. Find me on <a href=https://github.com/matthiask/>GitHub</a>, <a href=https://hachyderm.io/@matthiask rel=me>Mastodon</a>, <a rel="noopener noreferrer"title="if you must"href=https://www.linkedin.com/in/matthiaskestenholz target=_blank>LinkedIn</a> or by <a href=mailto:mk@406.ch>email</a>.<nav><a href=/writing/category-climate/>Climate</a><a href=/writing/category-django/>Django</a><a href=/writing/category-feincms/>feincms</a><a href=/writing/category-politik/>Politik</a><a href=/writing/category-programming/>Programming</a><a href=/writing/category-python/>Python</a><a href=/writing/category-weeknotes/>Weeknotes</a></nav></div></header><main><div class=wrappy><div class=text><small>2022-11-13 </small><h1 id=moving-data-including-deletions-between-the-same-django-app-running-in-different-environments><a class=toclink href=#moving-data-including-deletions-between-the-same-django-app-running-in-different-environments>Moving data including deletions between the same Django app running in different environments</a></h1><p>Many projects use different environments to stabilize the code; they have a <em>production</em> environment which is actually seen by users, a <em>stage</em> where code is tested in an environment close to production and maybe several additional environments where more experimental code is published or developed, either on internal or protected webservers or maybe on the workstations of developers themselves.<p>The same process may be desired for content; an environment where the content lives which is seen by users and other environments where the content can be changed without impacting the production environment. When using Django and the <a href=https://docs.djangoproject.com/en/4.1/ref/contrib/admin/>Django admin site</a> there is no ready-made solution for doing this and maybe there shouldn’t be.<h2 id=djangos-serialization-framework-and-its-shortcomings-for-the-use-case-outlined-above><a class=toclink href=#djangos-serialization-framework-and-its-shortcomings-for-the-use-case-outlined-above>Django’s serialization framework and its shortcomings for the use case outlined above</a></h2><p>Django comes with a <a href=https://docs.djangoproject.com/en/4.1/topics/serialization/>serialization framework</a> and with the <code>dumpdata</code> and <code>loaddata</code> management commands which can be used to dump and load data, e.g. to and from JSON. It’s also easily possible to specify a list of primary keys on the command line if you only want to dump a subset of the existing data. When loading this subset data which isn’t included isn’t changed in any way, and that’s good!<p><strong>However!</strong><p>Let’s assume we’re working with the question and choice models from <a href=https://docs.djangoproject.com/en/4.1/intro/tutorial02/#creating-models>Django’s tutorial</a>.<ul><li>The serialization framework doesn’t offer a way to easily include related data in a dump. There’s no easy way to automatically include all choices of a question.<li>Even if there was a way to include the related data the target environment wouldn’t have a way to replicate deletions. If a choice has been removed in the source environment it will not be included in the dump, and the target environment will just do nothing with the now redundant choice.</ul><h2 id=feincms3-data><a class=toclink href=#feincms3-data><a href=https://github.com/matthiask/feincms3-data/>feincms3-data</a></a></h2><p><a href=https://github.com/matthiask/feincms3-data/>feincms3-data</a> solves these problems in (I think) a nice way, by building on the serialization framework and augmenting the JSON dump with a few additional properties which tell the loader what to do with the dataset. The code doesn’t have a dependency on <a href=https://feincms3.readthedocs.io/>feincms3</a> but of course it’s very useful when used to dump and load structured data as is generated when using a CMS.<p>The following datasets configuration would work for the use case outlined above:<div class=chl><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>feincms3_data.data</span><span class=w> </span><span class=kn>import</span><span class=w> </span><span class=n>specs_for_models</span>
<span class=kn>from</span><span class=w> </span><span class=nn>polls</span><span class=w> </span><span class=kn>import</span><span class=w> </span><span class=n>models</span>

<span class=k>def</span><span class=w> </span><span class=nf>questions</span><span class=p>(</span><span class=n>args</span><span class=p>):</span>
<span class=w>    </span><span class=n>pks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>pk</span><span class=p>)</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>pk</span><span class=w> </span><span class=ow>in</span><span class=w> </span><span class=n>args</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>","</span><span class=p>)</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>pk</span><span class=p>]</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>[</span>
<span class=w>        </span><span class=o>*</span><span class=n>specs_for_models</span><span class=p>(</span>
<span class=w>            </span><span class=p>[</span><span class=n>models</span><span class=o>.</span><span class=n>Question</span><span class=p>],</span>
<span class=w>            </span><span class=p>{</span><span class=s2>"filter"</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=s2>"pk__in"</span><span class=p>:</span><span class=w> </span><span class=n>pks</span><span class=p>}},</span>
<span class=w>        </span><span class=p>),</span>
<span class=w>        </span><span class=o>*</span><span class=n>specs_for_models</span><span class=p>(</span>
<span class=w>            </span><span class=p>[</span><span class=n>models</span><span class=o>.</span><span class=n>Answer</span><span class=p>],</span>
<span class=w>            </span><span class=p>{</span><span class=s2>"filter"</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=s2>"question__pk__in"</span><span class=p>:</span><span class=w> </span><span class=n>pks</span><span class=p>},</span><span class=w> </span><span class=s2>"delete_missing"</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=p>},</span>
<span class=w>        </span><span class=p>),</span>
<span class=w>    </span><span class=p>]</span>

<span class=k>def</span><span class=w> </span><span class=nf>datasets</span><span class=p>():</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>{</span><span class=s2>"default"</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=s2>"specs"</span><span class=p>:</span><span class=w> </span><span class=n>questions</span><span class=p>}}</span>
</code></pre></div><p>Now, you have to point the <code>FEINCMS3_DATA_DATASETS</code> setting at the <code>datasets()</code> function above and now you could use <code>./manage.py f3dumpdata default:3,4</code> to dump the questions with ID 3 and 4 including their choices. The JSON can be loaded in a different instance. The questions with ID 3 and 4 will be created or updated, and choices which match the <code>questions__pk__in=[3,4]</code> filter <em>but aren’t included in the JSON</em> will be removed from the database.<p>Despite its pre-1.0 version number it’s used for several clients to implement a workflow where they set a “request update” flag on some parent object, and the relevant data will be synced periodically between systems. I’m quite confident that the code is correct and that it does what it should. A thorough test suite helps a lot there! But you never now, but I’m sure everyone uses backups by now. But who knows.</div></div></main><footer><div class=wrappy><p><small> I like feedback! <a href="mailto:mk@406.ch?subject=Moving data including deletions between the same Django app running in different environments">Send me an email.</a> <br> <a rel="noopener noreferrer"href=https://ko-fi.com/matthiask target=_blank>☕ Buy me a coffee?</a> <br> Published on 2022-11-13 in <a href=/writing/category-django/>Django</a>, <a href=/writing/category-programming/>Programming</a>, <a href=/writing/category-feincms/>feincms</a> </small></p><script async crossorigin issue-term=pathname repo=matthiask/406-comments src=https://utteranc.es/client.js theme=github-light></script></div></footer>