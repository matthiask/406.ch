<!doctype html><html lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>Preserving referential integrity with JSON fields and Django - Matthias Kestenholz</title><link href=/styles.6cf33c7d4923.css rel=stylesheet><link title="Blog feed" href=/writing/atom.xml rel=alternate type=application/atom+xml><body><header><div class=wrappy><a class=title href=/>Hi, I'm Matthias</a><p class=subtitle>I am a founding partner of <a href=https://feinheit.ch>Feinheit AG</a> and <a href=https://diebruchpiloten.com>Die Bruchpiloten AG</a>. Find me on <a href=https://github.com/matthiask/>GitHub</a>, <a href=https://hachyderm.io/@matthiask rel=me>Mastodon</a>, <a href=https://bsky.app/profile/matthiask.406.ch rel=me>Bluesky</a>, <a rel="noopener noreferrer" title="if you must" href=https://www.linkedin.com/in/matthiaskestenholz target=_blank>LinkedIn</a> or by <a href=mailto:mk@406.ch>email</a>.<nav><a href=/writing/category-climate/>Climate</a><a href=/writing/category-django/>Django</a><a href=/writing/category-feincms/>feincms</a><a href=/writing/category-politik/>Politik</a><a href=/writing/category-programming/>Programming</a><a href=/writing/category-python/>Python</a><a href=/writing/category-til/>TIL</a><a href=/writing/category-weeknotes/>Weeknotes</a></nav></div></header><main><div class=wrappy><div class=text><small>2025-06-04 </small><h1 id=preserving-referential-integrity-with-json-fields-and-django><a class=toclink href=#preserving-referential-integrity-with-json-fields-and-django>Preserving referential integrity with JSON fields and Django</a></h1><h2 id=motivation><a class=toclink href=#motivation>Motivation</a></h2><p>The great thing about using <a href=https://feincms3.readthedocs.io/>feincms3</a> and <a href=https://django-content-editor.readthedocs.io/>django-content-editor</a> is that CMS plugins are Django models – if using them you immediately have access to the power of Django’s ORM and Django’s administration interface.<p>However, using one model per content type can be limiting on larger sites. Because of this <a href=https://feinheit.ch/>we</a> like using JSON plugins with schemas for more fringe use cases or for places where we have richer data but do not want to write a separate Django app for it. This works well as long as you only work with text, numbers etc. but gets a bit ugly once you start referencing Django models because you never know if those objects are still around when actually using the data stored in those JSON fields.<p>Django has a nice <a href=https://docs.djangoproject.com/en/5.2/ref/models/fields/#django.db.models.ForeignKey.on_delete><code>on_delete=models.PROTECT</code></a> feature, but that of course only works when using real models. So, let’s bridge this gap and allow using foreign key protection with data stored in JSON fields!<h2 id=models><a class=toclink href=#models>Models</a></h2><p>First, you have to start using the <a href=https://github.com/matthiask/django-json-schema-editor>django-json-schema-editor</a> and specifically its <code>JSONField</code> instead of the standard Django <code>JSONField</code>. The most important difference between those two is that the schema editor’s field wants a JSON schema. So, for the sake of an example, let’s assume that we have a model with images and a model with galleries. Note that we’re omitting many of the fields actually making the interface nice such as titles etc.<div class=chl><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>django.db</span><span class=w> </span><span class=kn>import</span> <span class=n>models</span>
<span class=kn>from</span><span class=w> </span><span class=nn>django_json_schema_editor.fields</span><span class=w> </span><span class=kn>import</span> <span class=n>JSONField</span>

<span class=k>class</span><span class=w> </span><span class=nc>Image</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>image</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>ImageField</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>

<span class=n>gallery_schema</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s2>"type"</span><span class=p>:</span> <span class=s2>"object"</span><span class=p>,</span>
    <span class=s2>"properties"</span><span class=p>:</span> <span class=p>{</span>
        <span class=s2>"caption"</span><span class=p>:</span> <span class=p>{</span><span class=s2>"type"</span><span class=p>:</span> <span class=s2>"string"</span><span class=p>},</span>
        <span class=s2>"images"</span><span class=p>:</span> <span class=p>{</span>
            <span class=s2>"type"</span><span class=p>:</span> <span class=s2>"array"</span><span class=p>,</span>
            <span class=s2>"format"</span><span class=p>:</span> <span class=s2>"table"</span><span class=p>,</span>
            <span class=s2>"minItems"</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
            <span class=s2>"items"</span><span class=p>:</span> <span class=p>{</span>
                <span class=s2>"type"</span><span class=p>:</span> <span class=s2>"string"</span><span class=p>,</span>
                <span class=s2>"format"</span><span class=p>:</span> <span class=s2>"foreign_key"</span><span class=p>,</span>
                <span class=s2>"options"</span><span class=p>:</span> <span class=p>{</span>
                    <span class=c1># raw_id_fields URL:</span>
                    <span class=s2>"url"</span><span class=p>:</span> <span class=s2>"/admin/myapp/image/?_popup=1&_to_field=id"</span><span class=p>,</span>
                <span class=p>},</span>
            <span class=p>},</span>
        <span class=p>},</span>
    <span class=p>},</span>
<span class=p>}</span>

<span class=k>class</span><span class=w> </span><span class=nc>Gallery</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>data</span> <span class=o>=</span> <span class=n>JSONField</span><span class=p>(</span><span class=n>schema</span><span class=o>=</span><span class=n>gallery_schema</span><span class=p>)</span>
</code></pre></div><p>Now, if we were to do it by hand, we’d define a <code>through</code> model for a <code>ManyToManyField</code> linking galleries to images, and adding a <code>on_delete=models.PROTECT</code> foreign key to this through model’s <code>image</code> foreign key and we would be updating this many to many table when the <code>Gallery</code> object changes. Since that’s somewhat <a href=https://github.com/matthiask/django-json-schema-editor/blob/4bc1ab0cf44eda4c0e824f96f2bd08cd94832c1c/django_json_schema_editor/fields.py#L9-L47>boring but also tricky code</a> I have already written it (including unit tests of course) and all that’s left to do is define the linking:<div class=chl><pre><span></span><code><span class=n>Gallery</span><span class=o>.</span><span class=n>register_data_reference</span><span class=p>(</span>
    <span class=c1># The model we're referencing:</span>
    <span class=n>Image</span><span class=p>,</span>
    <span class=c1># The name of the ManyToManyField:</span>
    <span class=n>name</span><span class=o>=</span><span class=s2>"images"</span><span class=p>,</span>
    <span class=c1># The getter which returns a list of stringified primary key values or nothing:</span>
    <span class=n>getter</span><span class=o>=</span><span class=k>lambda</span> <span class=n>obj</span><span class=p>:</span> <span class=n>obj</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>"images"</span><span class=p>),</span>
<span class=p>)</span>
</code></pre></div><p>Now, attempting to delete an image which is still used in a gallery somewhere will raise <a href=https://docs.djangoproject.com/en/5.2/ref/exceptions/#django.db.models.ProtectedError>ProtectedError</a> exceptions. That’s what we wanted to achieve.<h2 id=using-a-gallery-instance><a class=toclink href=#using-a-gallery-instance>Using a gallery instance</a></h2><p>When you have a gallery instance you can now use the <code>images</code> field to fetch all images and use the order from the JSON data:<div class=chl><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>gallery_context</span><span class=p>(</span><span class=n>gallery</span><span class=p>):</span>
    <span class=n>images</span> <span class=o>=</span> <span class=p>{</span><span class=nb>str</span><span class=p>(</span><span class=n>image</span><span class=o>.</span><span class=n>pk</span><span class=p>):</span> <span class=n>image</span> <span class=k>for</span> <span class=n>image</span> <span class=ow>in</span> <span class=n>gallery</span><span class=o>.</span><span class=n>images</span><span class=o>.</span><span class=n>all</span><span class=p>()}</span>
    <span class=k>return</span> <span class=p>{</span>
        <span class=s2>"caption"</span><span class=p>:</span> <span class=n>gallery</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s2>"caption"</span><span class=p>],</span>
        <span class=s2>"images"</span><span class=p>:</span> <span class=p>[</span><span class=n>images</span><span class=p>[</span><span class=n>pk</span><span class=p>]</span> <span class=k>for</span> <span class=n>pk</span> <span class=ow>in</span> <span class=n>gallery</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s2>"images"</span><span class=p>]],</span>
    <span class=p>}</span>
</code></pre></div><h2 id=jsonpluginbase-and-jsonplugininline><a class=toclink href=#jsonpluginbase-and-jsonplugininline>JSONPluginBase and JSONPluginInline</a></h2><p>I would generally do the instantiation of models slightly differently and use <code>django-json-schema-editor</code>’s <code>JSONPluginBase</code> and <code>JSONPluginInline</code> which offer additional niceties such as streamlined JSON models with only one backing database table (using <a href=https://docs.djangoproject.com/en/5.2/topics/db/models/#proxy-models>proxy models</a>) and supporting not just showing the primary key of referenced model instances but also their <code>__str__</code> value.<p>The example above would have to be changed to look more like this:<div class=chl><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>django_json_schema_editor</span><span class=w> </span><span class=kn>import</span> <span class=n>JSONPluginBase</span>

<span class=k>class</span><span class=w> </span><span class=nc>JSONPlugin</span><span class=p>(</span><span class=n>JSONPluginBase</span><span class=p>,</span> <span class=o>...</span><span class=p>):</span>
    <span class=k>pass</span>

<span class=n>JSONPlugin</span><span class=o>.</span><span class=n>register_data_reference</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>

<span class=n>Gallery</span> <span class=o>=</span> <span class=n>JSONPlugin</span><span class=o>.</span><span class=n>proxy</span><span class=p>(</span><span class=s2>"gallery"</span><span class=p>,</span> <span class=n>schema</span><span class=o>=</span><span class=n>gallery_schema</span><span class=p>)</span>
</code></pre></div><p>However, that’s not documented yet so for now you unfortunately have to read the <a href=https://github.com/matthiask/django-json-schema-editor>code and the test suite</a>, sorry for that. It’s used heavily in production though so if you start using it it won’t suddenly start breaking in the future.</div><div class="text prevnext"><a href=/writing/weeknotes-2025-week-27/>Newer post</a><a href=/writing/how-i-m-bundling-frontend-assets-using-django-and-rspack-these-days/>Older post</a></div></div></main><footer><div class=wrappy><p><small> I like feedback! <a href="mailto:mk@406.ch?subject=Preserving referential integrity with JSON fields and Django">Send me an email.</a> <br> <a rel="noopener noreferrer" href=https://ko-fi.com/matthiask target=_blank>☕ Buy me a coffee?</a> <br> Published on 2025-06-04 in <a href=/writing/category-django/>Django</a>, <a href=/writing/category-programming/>Programming</a>, <a href=/writing/category-feincms/>feincms</a> </small></p><script async crossorigin issue-term=pathname repo=matthiask/406-comments src=https://utteranc.es/client.js theme=github-dark></script></div></footer>