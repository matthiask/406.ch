<!doctypehtml><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0 name=viewport><title>Weeknotes (2023 week 40) - Matthias Kestenholz</title><link href=/styles.b44ef9b6c00e.css rel=stylesheet><link title="Blog feed"href=/writing/atom.xml rel=alternate type=application/atom+xml><body><header><div class=wrappy><a class=title href=/>Hi, I'm Matthias</a><p class=subtitle>I am a founding partner of <a href=https://feinheit.ch>Feinheit AG</a> and <a href=https://diebruchpiloten.com>Die Bruchpiloten AG</a>. Find me on <a href=https://github.com/matthiask/>GitHub</a>, <a href=https://hachyderm.io/@matthiask rel=me>Mastodon</a>, <a rel="noopener noreferrer"title="if you must"href=https://www.linkedin.com/in/matthiaskestenholz target=_blank>LinkedIn</a> or by <a href=mailto:mk@406.ch>email</a>.<nav><a href=/writing/category-climate/>Climate</a><a href=/writing/category-django/>Django</a><a href=/writing/category-feincms/>feincms</a><a href=/writing/category-politik/>Politik</a><a href=/writing/category-programming/>Programming</a><a href=/writing/category-python/>Python</a><a href=/writing/category-weeknotes/>Weeknotes</a></nav></div></header><main><div class=wrappy><div class=text><small>2023-10-04 </small><h1>Weeknotes (2023 week 40)</h1><h2>More work on hosting several websites from a single Django application server using feincms3-sites</h2><p>I have mentioned feincms3-sites last week in my last weeknotes entry; I have again given this package a lot of attention in the last days, so another update is in order.<p>It is now possible to override the list of languages available on each site. That’s especially useful for an upcoming campaign site where the umbrella group’s site is available in three languages, but (most?) individual group sites (hosted on subdomains) will only have a subset of languages. Since I live in a country with four national languages (english isn’t one of them, but is spoken by many!) supporting more than one language, or even many languages is totally commonplace. It’s great that Django has good support for internationalization. For the sake of an example, I have the following sites:<ul><li><code>example.com</code>: The default. The host has to match exactly.<li><code>subdomain.example.com</code>: One individual group’s site. The host has to match the regex <code>^subdomain\.</code> (sorry, I actually do like regexes).</ul><h3>Overriding configured hosts for local development</h3><p>One thing which always annoyed me when using <code>django.contrib.sites</code> was that “just” pulling the database from production to the local development environment always produced links pointing back to the remote host instead of working locally (when producing absolute URLs). This problem was shared by feincms3-sites as well. I have now found a very ugly but perfectly workable solution: Overwrite <code>Site.get_host()</code> locally:<div class=chl><pre><span></span><code><span class=k>if</span> <span class=n>DEBUG</span><span class=p>:</span>
    <span class=n>domain</span> <span class=o>=</span> <span class=s2>"example.com"</span>  <span class=c1># Or whatever</span>
    <span class=n>_get_host</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>site</span><span class=p>:</span> <span class=n>site</span><span class=o>.</span><span class=n>host</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=n>domain</span><span class=p>,</span> <span class=s2>"localhost:8000"</span><span class=p>)</span>
    <span class=n>FEINCMS3_SITES_SITE_GET_HOST</span> <span class=o>=</span> <span class=n>_get_host</span>
</code></pre></div><p>This works especially well when using <code>example.com</code> and maybe subdomains of <code>example.com</code>: All absolute links will point to <code>localhost:8000</code> or <code>subdomain.localhost:8000</code>. Since <code>*.localhost</code> always resolves to the local IP the browser knows where it should connect to, and since <code>subdomain.localhost:8000</code> also matches the <code>^subdomain\.</code> regex mentioned above, the site selection logic works as well.<p>Of course if you have more domains, not just subdomains, you could adapt the <code>get_host</code> override and the relevant regexes to those use cases.<h3>Closing words</h3><p>We’re at 100% code coverage now when running the test suite. That’s really nice.<h2>Logging into the Django admin using your Google account</h2><p>This functionality has long been provided by <a href=https://pypi.org/project/django-authlib/>django-admin-sso</a>; however, as mentioned a long time ago this package still uses a deprecated OAuth2 library. <a href=https://github.com/matthiask/django-authlib/>django-authlib</a> supports using a Google account to authenticate with the Django admin since 2017. I have now fixed a small problem with it: If you are logged into a single Google account, and this account’s email address doesn’t match the configured admin login rule, you were out of luck: There was no way to add another account at that time because the library didn’t request the account selection. That has changed now, if the first login attempt doesn’t work, it now explicitly tells Google to let the user select their Google account. A small quality of life improvement for those using more than one Google account (voluntarily or not).<h2>Releases</h2><ul><li><a href=https://pypi.org/project/feincms3/>feincms3 4.4.3</a>: Polished the CKEditor integration a little bit. Re-enabled the source button now that we’re back to using the classic iframe-based editor again.<li><a href=https://pypi.org/project/feincms3-sites/>feincms3-sites 0.19.3</a>: See above.<li><a href=https://pypi.org/project/django-authlib/>django-authlib 0.16.4</a>: See above.</ul></div></div></main><footer><div class=wrappy><p><small> I like feedback! <a href="mailto:mk@406.ch?subject=Weeknotes (2023 week 40)">Send me an email.</a> <br> <a rel="noopener noreferrer"href=https://ko-fi.com/matthiask target=_blank>☕ Buy me a coffee?</a> <br> Published on 2023-10-04 in <a href=/writing/category-django/>Django</a>, <a href=/writing/category-programming/>Programming</a>, <a href=/writing/category-weeknotes/>Weeknotes</a>, <a href=/writing/category-feincms/>feincms</a> </small></p><script async crossorigin issue-term=pathname repo=matthiask/406-comments src=https://utteranc.es/client.js theme=github-light></script></div></footer>