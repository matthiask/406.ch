<!doctypehtml><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0 name=viewport><title>django-content-editor now supports nested sections - Matthias Kestenholz</title><link href=/styles.7a4c5338b9f2.css rel=stylesheet><link title="Blog feed"href=/writing/atom.xml rel=alternate type=application/atom+xml><body><header><div class=wrappy><a class=title href=/>Hi, I'm Matthias</a><p class=subtitle>I am a founding partner of <a href=https://feinheit.ch>Feinheit AG</a> and <a href=https://diebruchpiloten.com>Die Bruchpiloten AG</a>. Find me on <a href=https://github.com/matthiask/>GitHub</a>, <a href=https://hachyderm.io/@matthiask rel=me>Mastodon</a>, <a href=https://bsky.app/profile/matthiask.406.ch rel=me>Bluesky</a>, <a rel="noopener noreferrer"title="if you must"href=https://www.linkedin.com/in/matthiaskestenholz target=_blank>LinkedIn</a> or by <a href=mailto:mk@406.ch>email</a>.<nav><a href=/writing/category-climate/>Climate</a><a href=/writing/category-django/>Django</a><a href=/writing/category-feincms/>feincms</a><a href=/writing/category-feincms3/>feincms3</a><a href=/writing/category-politik/>Politik</a><a href=/writing/category-programming/>Programming</a><a href=/writing/category-python/>Python</a><a href=/writing/category-til/>TIL</a><a href=/writing/category-weeknotes/>Weeknotes</a></nav></div></header><main><div class=wrappy><div class=text><small>2024-09-13 </small><h1 id=django-content-editor-now-supports-nested-sections><a class=toclink href=#django-content-editor-now-supports-nested-sections>django-content-editor now supports nested sections</a></h1><p><a href=https://django-content-editor.readthedocs.io/>django-content-editor</a> (and it’s ancestor FeinCMS) has been the Django admin extension for editing content consisting of reusable blocks since 2009. In the last years we have more and more often started <a href=https://feincms3.readthedocs.io/en/latest/guides/rendering.html#grouping-plugins-into-subregions>automatically grouping related items</a>, e.g. for rendering a sequence of images as a gallery. But, sometimes it’s nice to give editors more control. This has been possible by using blocks which open a subsection and blocks which close a subsection for a long time, but it hasn’t been friendly to content managers, especially when using nested sections.<p>The content editor now has first-class support for such nested sections. Here’s a screenshot showing the nesting:<p><img alt="django-content-editor with sections"src=https://406.ch/assets/20240911-content-editor-sections.png><p>Finally it’s possible to visually group blocks into sections, collapse those sections as once and drag and drop whole sections into their place instead of having to select the involved blocks individually.<p>The best part about it is that the content editor still supports all Django admin widgets, as long as those widgets have support for the Django administration interface’s <a href=https://docs.djangoproject.com/en/latest/ref/contrib/admin/javascript/>inline form events</a>! Moving DOM nodes around breaks attached JavaScript behaviors, but we do not actually move DOM nodes around after the initialization – instead, we use <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_flexible_box_layout/Ordering_flex_items>Flexbox ordering</a> to visually reorder blocks. It’s a bit more work than using a ready-made sortable plugin, but – as mentioned – the prize is that we don’t break any other Django admin extensions.<h2 id=simple-patterns><a class=toclink href=#simple-patterns>Simple patterns</a></h2><p>I previously already reacted to a blog post by Lincoln Loop here in my post <a href=https://406.ch/writing/my-reaction-to-the-block-driven-cms-blog-post/>My reaction to the block-driven CMS blog post</a>.<p>The latest blog post, <a href=https://lincolnloop.com/insights/simple-block-pattern-wagtail-cms/>Solving the Messy Middle: a Simple Block Pattern for Wagtail CMS</a> was interesting as well. It dives into the configuration of a <a href=https://wagtail.org/>Wagtail</a> stream field which allows composing content out of reusable blocks of content (<a href=https://406.ch/writing/i-just-learned-about-wagtail-s-streamfield/>sounds familiar!</a>). The result is saved in a JSON blob in the database with all the advantages and disadvantages that entails.<p>Now, django-content-editor is a worthy competitor when you do not want to add another interface to your website besides the user-facing frontend and the Django administration interface.<p>The example from the Lincoln Loop blog post can be replicated quite closely with django-content-editor by using sections. I’m using the <a href=https://pypi.org/project/django-json-schema-editor/>django-json-schema-editor</a> package for the section plugin since it easily allows adding more fields if some section type needs it.<p>Here’s an example model definition:<div class=chl><pre><span></span><code><span class=c1># Models</span>
<span class=kn>from</span> <span class=nn>content_editor.models</span> <span class=kn>import</span> <span class=n>Region</span><span class=p>,</span> <span class=n>create_plugin_base</span>
<span class=kn>from</span> <span class=nn>django_json_schema_editor.plugins</span> <span class=kn>import</span> <span class=n>JSONPluginBase</span>
<span class=kn>from</span> <span class=nn>feincms3</span> <span class=kn>import</span> <span class=n>plugins</span>

<span class=k>class</span> <span class=nc>Page</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=c1># You have to define regions; each region gets a tab in the admin interface</span>
    <span class=n>regions</span> <span class=o>=</span> <span class=p>[</span><span class=n>Region</span><span class=p>(</span><span class=n>key</span><span class=o>=</span><span class=s2>"content"</span><span class=p>,</span> <span class=n>title</span><span class=o>=</span><span class=s2>"Content"</span><span class=p>)]</span>

    <span class=c1># Additional fields for the page...</span>

<span class=n>PagePlugin</span> <span class=o>=</span> <span class=n>create_plugin_base</span><span class=p>(</span><span class=n>Page</span><span class=p>)</span>

<span class=k>class</span> <span class=nc>RichText</span><span class=p>(</span><span class=n>plugins</span><span class=o>.</span><span class=n>richtext</span><span class=o>.</span><span class=n>RichText</span><span class=p>,</span> <span class=n>PagePlugin</span><span class=p>):</span>
    <span class=k>pass</span>

<span class=k>class</span> <span class=nc>Image</span><span class=p>(</span><span class=n>plugins</span><span class=o>.</span><span class=n>image</span><span class=o>.</span><span class=n>Image</span><span class=p>,</span> <span class=n>PagePlugin</span><span class=p>):</span>
    <span class=k>pass</span>

<span class=k>class</span> <span class=nc>Section</span><span class=p>(</span><span class=n>JSONPluginBase</span><span class=p>,</span> <span class=n>PagePlugin</span><span class=p>):</span>
    <span class=k>pass</span>

<span class=n>AccordionSection</span> <span class=o>=</span> <span class=n>Section</span><span class=o>.</span><span class=n>proxy</span><span class=p>(</span>
    <span class=s2>"accordion"</span><span class=p>,</span>
    <span class=n>schema</span><span class=o>=</span><span class=p>{</span><span class=s2>"type"</span><span class=p>:</span> <span class=s2>"object"</span><span class=p>,</span> <span class=p>{</span><span class=s2>"properties"</span><span class=p>:</span> <span class=p>{</span><span class=s2>"title"</span><span class=p>:</span> <span class=p>{</span><span class=s2>"type"</span><span class=p>:</span> <span class=s2>"string"</span><span class=p>}}}},</span>
<span class=p>)</span>
<span class=n>CloseSection</span> <span class=o>=</span> <span class=n>Section</span><span class=o>.</span><span class=n>proxy</span><span class=p>(</span>
    <span class=s2>"close"</span><span class=p>,</span>
    <span class=n>schema</span><span class=o>=</span><span class=p>{</span><span class=s2>"type"</span><span class=p>:</span> <span class=s2>"object"</span><span class=p>,</span> <span class=p>{</span><span class=s2>"properties"</span><span class=p>:</span> <span class=p>{}}},</span>
<span class=p>)</span>
</code></pre></div><p>Here’s the corresponding admin definition:<div class=chl><pre><span></span><code><span class=c1># Admin</span>
<span class=kn>from</span> <span class=nn>content_editor.admin</span> <span class=kn>import</span> <span class=n>ContentEditor</span>
<span class=kn>from</span> <span class=nn>django_json_schema_editor.plugins</span> <span class=kn>import</span> <span class=n>JSONPluginInline</span>
<span class=kn>from</span> <span class=nn>feincms3</span> <span class=kn>import</span> <span class=n>plugins</span>

<span class=nd>@admin</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Page</span><span class=p>)</span>
<span class=k>class</span> <span class=nc>PageAdmin</span><span class=p>(</span><span class=n>ContentEditor</span><span class=p>):</span>
    <span class=n>inlines</span> <span class=o>=</span> <span class=p>[</span>
        <span class=n>plugins</span><span class=o>.</span><span class=n>richtext</span><span class=o>.</span><span class=n>RichTextInline</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>RichText</span><span class=p>),</span>
        <span class=n>plugins</span><span class=o>.</span><span class=n>image</span><span class=o>.</span><span class=n>ImageInline</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Image</span><span class=p>),</span>
        <span class=n>JSONPluginInline</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>AccordionSection</span><span class=p>,</span> <span class=n>sections</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
        <span class=n>JSONPluginInline</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>CloseSection</span><span class=p>,</span> <span class=n>sections</span><span class=o>=-</span><span class=mi>1</span><span class=p>),</span>
    <span class=p>]</span>
</code></pre></div><p>The somewhat cryptic <code>sections=</code> argument says how many levels of sections the individual blocks open or close.<p>To render the content including accordions I’d probably use a <a href=https://feincms3.readthedocs.io/en/latest/guides/rendering.html#using-marks>feincms3 renderer</a>. At the time of writing the renderer definition for sections is a bit tricky.<div class=chl><pre><span></span><code><span class=kn>from</span> <span class=nn>feincms3.renderer</span> <span class=kn>import</span> <span class=n>RegionRenderer</span><span class=p>,</span> <span class=n>render_in_context</span><span class=p>,</span> <span class=n>template_renderer</span>

<span class=k>class</span> <span class=nc>PageRenderer</span><span class=p>(</span><span class=n>RegionRenderer</span><span class=p>):</span>
    <span class=k>def</span> <span class=nf>handle</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>plugins</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
        <span class=n>plugins</span> <span class=o>=</span> <span class=n>deque</span><span class=p>(</span><span class=n>plugins</span><span class=p>)</span>
        <span class=k>yield from</span> <span class=bp>self</span><span class=o>.</span><span class=n>_handle</span><span class=p>(</span><span class=n>plugins</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>_handle</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>plugins</span><span class=p>,</span> <span class=n>context</span><span class=p>,</span> <span class=o>*</span><span class=p>,</span> <span class=n>in_section</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
        <span class=k>while</span> <span class=n>plugins</span><span class=p>:</span>
            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>plugins</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>models</span><span class=o>.</span><span class=n>Section</span><span class=p>):</span>
                <span class=n>section</span> <span class=o>=</span> <span class=n>plugins</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
                <span class=k>if</span> <span class=n>section</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=s2>"close"</span><span class=p>:</span>
                    <span class=k>if</span> <span class=n>in_section</span><span class=p>:</span>
                        <span class=k>return</span>
                    <span class=c1># Ignore close section plugins when not inside section</span>
                    <span class=k>continue</span>

                <span class=k>if</span> <span class=n>section</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=s2>"accordion"</span><span class=p>:</span>
                    <span class=k>yield</span> <span class=n>render_in_context</span><span class=p>(</span><span class=s2>"accordion.html"</span><span class=p>,</span> <span class=p>{</span>
                        <span class=s2>"title"</span><span class=p>:</span> <span class=n>accordion</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=s2>"title"</span><span class=p>],</span>
                        <span class=s2>"content"</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_handle</span><span class=p>(</span><span class=n>plugins</span><span class=p>,</span> <span class=n>context</span><span class=p>,</span> <span class=n>in_section</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>
                    <span class=p>})</span>

            <span class=k>else</span><span class=p>:</span>
                <span class=k>yield</span> <span class=bp>self</span><span class=o>.</span><span class=n>render_plugin</span><span class=p>(</span><span class=n>plugin</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>

<span class=n>renderer</span> <span class=o>=</span> <span class=n>PageRenderer</span><span class=p>()</span>
<span class=n>renderer</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>RichText</span><span class=p>,</span> <span class=n>template_renderer</span><span class=p>(</span><span class=s2>"plugins/richtext.html"</span><span class=p>))</span>
<span class=n>renderer</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Image</span><span class=p>,</span> <span class=n>template_renderer</span><span class=p>(</span><span class=s2>"plugins/image.html"</span><span class=p>))</span>
<span class=n>renderer</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Section</span><span class=p>,</span> <span class=s2>""</span><span class=p>)</span>
</code></pre></div><h2 id=closing-thoughts><a class=toclink href=#closing-thoughts>Closing thoughts</a></h2><p>Sometimes, I think to myself, I’ll “just” write a “simple” blog post. I get what I deserve when using those forbidden words. This blog post is neither short or simple. That being said, the rendering code is a bit tricky, the rest is quite straightforward. The amount of code in django-content-editor and feincms3 is reasonable as well. Even though it may look like a lot you’ll still be <a href=https://406.ch/writing/run-less-code-in-production-or-youll-end-up-paying-the-price-later/>running less code in production</a> than when using comparable solutions built using Django.</div><div class="text prevnext"><a href=/writing/weeknotes-2024-week-39/>Previous post</a><a href=/writing/weeknotes-2024-week-37/>Next post</a></div></div></main><footer><div class=wrappy><p><small> I like feedback! <a href="mailto:mk@406.ch?subject=django-content-editor now supports nested sections">Send me an email.</a> <br> <a rel="noopener noreferrer"href=https://ko-fi.com/matthiask target=_blank>☕ Buy me a coffee?</a> <br> Published on 2024-09-13 in <a href=/writing/category-django/>Django</a>, <a href=/writing/category-programming/>Programming</a>, <a href=/writing/category-feincms3/>feincms3</a> </small></p><script async crossorigin issue-term=pathname repo=matthiask/406-comments src=https://utteranc.es/client.js theme=github-dark></script></div></footer>