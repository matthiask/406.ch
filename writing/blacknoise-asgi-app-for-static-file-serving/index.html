<!doctypehtml><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0 name=viewport><title>blacknoise – ASGI app for static file serving - Matthias Kestenholz</title><link href=/styles.d399359aea54.css rel=stylesheet><link title="Blog feed"href=/writing/atom.xml rel=alternate type=application/atom+xml><body><header><div class=wrappy><h1 class=title>Hi, I'm Matthias</h1><p class=subtitle>I am a founding partner of <a href=https://feinheit.ch>Feinheit AG</a> and <a href=https://diebruchpiloten.com>Die Bruchpiloten AG</a>. Find me on <a href=https://github.com/matthiask/>GitHub</a>, <a href=https://hachyderm.io/@matthiask rel=me>Mastodon</a>, <a rel="noopener noreferrer"title="if you must"href=https://www.linkedin.com/in/matthiaskestenholz target=_blank>LinkedIn</a> or by <a href=mailto:mk@406.ch>email</a>.<nav><a href=/>Archive</a><a href=/writing/category-climate/>Climate</a><a href=/writing/category-django/>Django</a><a href=/writing/category-feincms/>feincms</a><a href=/writing/category-politik/>Politik</a><a href=/writing/category-programming/>Programming</a><a href=/writing/category-python/>Python</a><a href=/writing/category-weeknotes/>Weeknotes</a></nav></div></header><main><div class=wrappy><div class=text><small>2024-03-20 </small><h1>blacknoise – ASGI app for static file serving</h1><div class="admonition note"><p class=admonition-title>Note<p>This blog post consists of the <a href=https://github.com/matthiask/blacknoise>blacknoise README</a> at the time of publishing.</div><p>blacknoise is an <a href=https://asgi.readthedocs.io/en/latest/>ASGI</a> app for static file serving inspired by <a href=https://github.com/evansd/whitenoise/>whitenoise</a> and following the principles of <a href=https://406.ch/writing/low-maintenance-software/>low maintenance software</a>.<p><strong>This is pre-alpha software and everything is subject to change. I’m not even sure if blacknoise should exist at all or if the energy wouldn’t be better spent improving whitenoise or other tools. Feedback and contributions are very welcome though!</strong><h2>Using blacknoise with Django to serve static files</h2><p>Install blacknoise into your Python environment:<div class=chl><pre><span></span><code><span class=go>pip install blacknoise</span>
</code></pre></div><p>Wrap your ASGI application with the <code>BlackNoise</code> app:<div class=chl><pre><span></span><code><span class=kn>from</span> <span class=nn>blacknoise</span> <span class=kn>import</span> <span class=n>BlackNoise</span>
<span class=kn>from</span> <span class=nn>django.core.asgi</span> <span class=kn>import</span> <span class=n>get_asgi_application</span>
<span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>

<span class=n>BASE_DIR</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=vm>__file__</span><span class=p>)</span><span class=o>.</span><span class=n>parent</span>

<span class=n>application</span> <span class=o>=</span> <span class=n>BlackNoise</span><span class=p>(</span><span class=n>get_asgi_application</span><span class=p>())</span>
<span class=n>application</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>BASE_DIR</span> <span class=o>/</span> <span class=s2>"static"</span><span class=p>,</span> <span class=s2>"/static"</span><span class=p>)</span>
</code></pre></div><p><code>BlackNoise</code> will automatically handle all paths below the prefixes added, and either return the files or return 404 errors if files do not exist. The files are added on server startup, which also means that <code>BlackNoise</code> only knows about files which existed at that particular point in time.<h2>Improving performance</h2><p><code>BlackNoise</code> has worse performance than when using an optimized webserver such as nginx and others. Sometimes it doesn’t matter much if the app is behind a caching reverse proxy or behind a content delivery network anyway. To further support this use case <code>BlackNoise</code> can be configured to serve media files with far-future expiry headers and has support for serving compressed assets.<p>Compressing is possible by running:<div class=chl><pre><span></span><code><span class=go>python -m blacknoise.compress static/</span>
</code></pre></div><p><code>BlackNoise</code> will try compress non-binary files using gzip or brotli (if the <a href=ttps://pypi.org/project/Brotli/>Brotli</a> library is available), and will serve the compressed version if the compression actually results in (significantly) smaller files and if the client also supports it.<p>Far-future expiry headers can be enabled by passing the <code>immutable_file_test</code> callable to the <code>BlackNoise</code> constructor:<div class=chl><pre><span></span><code><span class=k>def</span> <span class=nf>immutable_file_test</span><span class=p>(</span><span class=n>path</span><span class=p>):</span>
    <span class=k>return</span> <span class=kc>True</span>  <span class=c1># Enable far-future expiry headers for all files</span>

<span class=n>application</span> <span class=o>=</span> <span class=n>BlackNoise</span><span class=p>(</span>
    <span class=n>get_asgi_application</span><span class=p>(),</span>
    <span class=n>immutable_file_test</span><span class=o>=</span><span class=n>immutable_file_test</span><span class=p>,</span>
<span class=p>)</span>
</code></pre></div><p>Maybe you want to add some other logic, for example check if the path contains a hash based upon the contents of the static file. Such hashes can be added by Django’s <code>ManifestStaticFilesStorage</code> or by appropriately configuring bundlers such as <code>webpack</code> and others.<h2>License</h2><p><code>blacknoise</code> is distributed under the terms of the <a href=https://spdx.org/licenses/MIT.html>MIT</a> license.</div></div></main><footer><div class=wrappy><p><small> I like feedback! <a href="mailto:mk@406.ch?subject=blacknoise – ASGI app for static file serving">Send me an email.</a> <br> <a rel="noopener noreferrer"href=https://ko-fi.com/matthiask target=_blank>☕ Buy me a coffee?</a> <br> Published on 2024-03-20 in <a href=/writing/category-django/>Django</a>, <a href=/writing/category-programming/>Programming</a> </small></p><script async crossorigin issue-term=pathname repo=matthiask/406-comments src=https://utteranc.es/client.js theme=github-light></script></div></footer>