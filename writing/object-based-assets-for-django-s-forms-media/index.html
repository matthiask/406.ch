<!doctypehtml><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0 name=viewport><title>Object-based assets for Django's forms.Media - Matthias Kestenholz</title><link href=/styles.85553ee449ca.css rel=stylesheet><link title="Blog feed"href=/writing/atom.xml rel=alternate type=application/atom+xml><body><header><div class=wrappy><a class=title href=/>Hi, I'm Matthias</a><p class=subtitle>I am a founding partner of <a href=https://feinheit.ch>Feinheit AG</a> and <a href=https://diebruchpiloten.com>Die Bruchpiloten AG</a>. Find me on <a href=https://github.com/matthiask/>GitHub</a>, <a href=https://hachyderm.io/@matthiask rel=me>Mastodon</a>, <a href=https://bsky.app/profile/matthiask.406.ch rel=me>Bluesky</a>, <a rel="noopener noreferrer"title="if you must"href=https://www.linkedin.com/in/matthiaskestenholz target=_blank>LinkedIn</a> or by <a href=mailto:mk@406.ch>email</a>.<nav><a href=/writing/category-climate/>Climate</a><a href=/writing/category-django/>Django</a><a href=/writing/category-feincms/>feincms</a><a href=/writing/category-feincms3/>feincms3</a><a href=/writing/category-politik/>Politik</a><a href=/writing/category-programming/>Programming</a><a href=/writing/category-python/>Python</a><a href=/writing/category-weeknotes/>Weeknotes</a></nav></div></header><main><div class=wrappy><div class=text><small>2024-12-18 </small><h1 id=object-based-assets-for-djangos-formsmedia><a class=toclink href=#object-based-assets-for-djangos-formsmedia>Object-based assets for Django’s forms.Media</a></h1><p>The pull request for adding <a href=https://github.com/django/django/pull/18782>object-based script media assets into Django</a> is in a good state and I hope it will be merged soon. I have been using object-based assets long before <a href=https://github.com/django/django/commit/4c76ffc2d6c77>Django actually added support for them in 4.1</a> (<a href=https://github.com/feincms/django-content-editor/commit/82ac91ea7af2409bb3672e11c18871002ddc9753>since 2016</a>, that’s before Django 1.10!) by using a gross hack. Luckily I have been able to clean up the code when Django 4.1 landed.<p>I have been asking myself at times why I haven’t proposed the change to Django myself despite having been a user of something like this for such a long time. After all, I have been happily contributing issue reports, bug fixes and tests to Django. The process of adding new features sometimes is terribly frustrating though even when looking (and cheering) from the sidelines. It feels bad that adding another package to the <a href=https://pypi.org/user/matthiask/>list of packages I maintain</a> so clearly seems to be the better way to <strong>get things done</strong> compared to proposing a new feature for Django itself. I hope <a href=https://406.ch/writing/weeknotes-2024-week-49/>processes change somewhat</a>.<p>But I digress.<p>The <code>ProseEditorWidget</code> in <a href=https://github.com/matthiask/django-prose-editor/>django-prose-editor</a> wants to ship CSS, JavaScript and some JSON to the browser for the widget. So, of course I used object-based media assets for this instead of widget HTML templates. Media assets are deduplicated and sorted by Django. If different editor presets use differing lists of assets they are smartly merged by <code>forms.Media</code> using a topological sort. You get those niceties for free when using <code>forms.Media</code> and everything just works, so what’s not to like?<p>The only thing which isn’t to like is that Django, at the time of writing, doesn’t provide any classes helping with this. You can put strings into <code>forms.Media</code> or you can put objects with a <code>__html__()</code> method in there. The latter of course is all that’s needed to support more advanced use cases – and that’s exactly what <a href=https://pypi.org/project/django-js-asset/>django-js-asset</a> now provides, and what django-prose-editor uses.<p><a href=https://pypi.org/project/django-js-asset/>django-js-asset</a> has long supported a <code>JS</code> class with support for additional attributes, for example:<div class=chl><pre><span></span><code><span class=kn>from</span> <span class=nn>js_asset</span> <span class=kn>import</span> <span class=n>JS</span>

<span class=n>forms</span><span class=o>.</span><span class=n>Media</span><span class=p>(</span><span class=n>js</span><span class=o>=</span><span class=p>[</span>
    <span class=n>JS</span><span class=p>(</span><span class=s2>"asset.js"</span><span class=p>,</span> <span class=p>{</span><span class=s2>"id"</span><span class=p>:</span> <span class=s2>"asset-script"</span><span class=p>,</span> <span class=s2>"data-answer"</span><span class=p>:</span> <span class=s2>"42"</span><span class=p>}),</span>
<span class=p>])</span>
</code></pre></div><p>Since 3.0 the package also comes with a <code>CSS</code> and <code>JSON</code> class:<div class=chl><pre><span></span><code><span class=kn>from</span> <span class=nn>js_asset</span> <span class=kn>import</span> <span class=n>CSS</span><span class=p>,</span> <span class=n>JS</span><span class=p>,</span> <span class=n>JSON</span>

<span class=n>forms</span><span class=o>.</span><span class=n>Media</span><span class=p>(</span><span class=n>js</span><span class=o>=</span><span class=p>[</span>
    <span class=n>JSON</span><span class=p>({</span><span class=s2>"cfg"</span><span class=p>:</span> <span class=mi>42</span><span class=p>},</span> <span class=nb>id</span><span class=o>=</span><span class=s2>"widget-cfg"</span><span class=p>),</span>
    <span class=n>CSS</span><span class=p>(</span><span class=s2>"widget/style.css"</span><span class=p>),</span>
    <span class=n>CSS</span><span class=p>(</span><span class=s2>"p{color:red;}"</span><span class=p>,</span> <span class=n>inline</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>
    <span class=n>JS</span><span class=p>(</span><span class=s2>"widget/script.js"</span><span class=p>,</span> <span class=p>{</span><span class=s2>"type"</span><span class=p>:</span> <span class=s2>"module"</span><span class=p>}),</span>
<span class=p>])</span>
</code></pre></div><p>This produces the following HTML:<div class=chl><pre><span></span><code><span class=p><</span><span class=nt>script</span> <span class=na>id</span><span class=o>=</span><span class=s>"widget-cfg"</span> <span class=na>type</span><span class=o>=</span><span class=s>"application/json"</span><span class=p>>{</span><span class=s2>"cfg"</span><span class=o>:</span><span class=w> </span><span class=mf>42</span><span class=p>}&LT/</span><span class=nt>script</span><span class=p>></span>
<span class=p><</span><span class=nt>link</span> <span class=na>rel</span><span class=o>=</span><span class=s>"stylesheet"</span> <span class=na>href</span><span class=o>=</span><span class=s>"/static/widget/style.css"</span><span class=p>></span>
<span class=p><</span><span class=nt>style</span><span class=p>></span><span class=nt>p</span><span class=p>{</span><span class=k>color</span><span class=p>:</span><span class=kc>red</span><span class=p>;}&LT/</span><span class=nt>style</span><span class=p>></span>
<span class=p><</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>"/static/widget/script.js"</span> <span class=na>type</span><span class=o>=</span><span class=s>"module"</span><span class=p>>&LT/</span><span class=nt>script</span><span class=p>></span>
</code></pre></div><p>The code which is proposed for Django supports the JavaScript use case but with a slightly different API:<div class=chl><pre><span></span><code><span class=kn>from</span> <span class=nn>django.forms</span> <span class=kn>import</span> <span class=n>Script</span>

<span class=n>forms</span><span class=o>.</span><span class=n>Media</span><span class=p>(</span><span class=n>js</span><span class=o>=</span><span class=p>[</span>
    <span class=n>Script</span><span class=p>(</span><span class=s2>"widget/script.js"</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=s2>"module"</span><span class=p>),</span>
<span class=p>])</span>
</code></pre></div><p>This looks slightly nicer as long as you don’t use e.g. data attributes, because then you have to do:<div class=chl><pre><span></span><code><span class=kn>from</span> <span class=nn>django.forms</span> <span class=kn>import</span> <span class=n>Script</span>

<span class=n>forms</span><span class=o>.</span><span class=n>Media</span><span class=p>(</span><span class=n>js</span><span class=o>=</span><span class=p>[</span>
    <span class=n>Script</span><span class=p>(</span><span class=s2>"widget/script.js"</span><span class=p>,</span> <span class=o>**</span><span class=p>{</span><span class=s2>"data-cfg"</span><span class=p>:</span> <span class=o>...</span><span class=p>}),</span>
<span class=p>])</span>
</code></pre></div><p>I always forget that Python supports passing keyword arguments names which aren’t valid Python identifiers (but only when using <code>**kwargs</code>). I personally don’t care much either way, and when my packages can finally drop compatibility with Django versions which do not support all these functionalities yet I’ll finally be able to retire <a href=https://pypi.org/project/django-js-asset/>django-js-asset</a>. That won’t happen any time soon though, if only because I like supporting old versions of Django because I have so many Django-based websites running somewhere.</div><div class="text prevnext"><a href=/writing/weeknotes-2024-week-51/>Previous post</a><a href=/writing/weeknotes-2024-week-49/>Next post</a></div></div></main><footer><div class=wrappy><p><small> I like feedback! <a href="mailto:mk@406.ch?subject=Object-based assets for Django's forms.Media">Send me an email.</a> <br> <a rel="noopener noreferrer"href=https://ko-fi.com/matthiask target=_blank>☕ Buy me a coffee?</a> <br> Published on 2024-12-18 in <a href=/writing/category-django/>Django</a>, <a href=/writing/category-programming/>Programming</a> </small></p><script async crossorigin issue-term=pathname repo=matthiask/406-comments src=https://utteranc.es/client.js theme=github-light></script></div></footer>