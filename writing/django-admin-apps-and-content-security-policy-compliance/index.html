<!doctypehtml><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0 name=viewport><title>Django admin apps and Content Security Policy compliance - Matthias Kestenholz</title><link href=/styles.d2047758144a.css rel=stylesheet><link title="Blog feed"href=/writing/atom.xml rel=alternate type=application/atom+xml><body><header><div class=wrappy><a class=title href=/>Hi, I'm Matthias</a><p class=subtitle>I am a founding partner of <a href=https://feinheit.ch>Feinheit AG</a> and <a href=https://diebruchpiloten.com>Die Bruchpiloten AG</a>. Find me on <a href=https://github.com/matthiask/>GitHub</a>, <a href=https://hachyderm.io/@matthiask rel=me>Mastodon</a>, <a rel="noopener noreferrer"title="if you must"href=https://www.linkedin.com/in/matthiaskestenholz target=_blank>LinkedIn</a> or by <a href=mailto:mk@406.ch>email</a>.<nav><a href=/writing/category-climate/>Climate</a><a href=/writing/category-django/>Django</a><a href=/writing/category-feincms/>feincms</a><a href=/writing/category-politik/>Politik</a><a href=/writing/category-programming/>Programming</a><a href=/writing/category-python/>Python</a><a href=/writing/category-weeknotes/>Weeknotes</a></nav></div></header><main><div class=wrappy><div class=text><small>2017-06-11 </small><h1 id=django-admin-apps-and-content-security-policy-compliance><a class=toclink href=#django-admin-apps-and-content-security-policy-compliance>Django admin apps and Content Security Policy compliance</a></h1><p>Since Django 1.10 the bundled admin app <a href=https://github.com/django/django/commit/d638cdc42acec608c1967f44af6be32a477c239f>does not use inline JavaScript anymore</a>. This means that a vanilla installation of <code>django.contrib.admin</code> without any additional apps (and additional functionality) would already be <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP>Content Security Policy</a> (CSP) compliant.<p>However, most – if not all – of our projects use apps that need to load additional JavaScript. Of course overriding templates is easy, and adding <code>&LTscript></code> tags as well, but this approach quickly leads to duplicated code in our projects. It got a little bit better since Django supports extending templates recursively, but I don’t really want to debug this if things go wrong.<p>An example for such an app is <a href=https://github.com/matthiask/django-admin-ordering/>django-admin-ordering</a>, an app which adds drag-drop reordering to inlines and changelists. The JavaScript code has to know the name of the ordering field and the name of inlines. <a href=https://github.com/matthiask/django-js-asset/>django-js-asset</a> provides a straightforward way of passing those attributes to the JavaScript code without having to override any templates, which helps <a href=/writing/low-maintenance-software/>keeping maintenance low</a>. The app (ab)uses the <code>forms.Media</code> container to also add data attributes to script tags. Those data attributes only contain JSON which (according to my understanding of CSP) is safe.<p>Instead of this:<div class=chl><pre><span></span><code>forms.Media(js=["admin_ordering/admin_ordering.js"])
</code></pre></div><p>… we do this:<div class=chl><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>js_asset</span><span class=w> </span><span class=kn>import</span><span class=w> </span><span class=n>JS</span>
<span class=n>forms</span><span class=o>.</span><span class=n>Media</span><span class=p>(</span><span class=n>js</span><span class=o>=</span><span class=p>[</span>
<span class=w>    </span><span class=n>JS</span><span class=p>(</span>
<span class=w>        </span><span class=s2>"admin_ordering/admin_ordering.js"</span><span class=p>,</span>
<span class=w>        </span><span class=p>{</span>
<span class=w>            </span><span class=s2>"data-admin-ordering"</span><span class=p>:</span><span class=w> </span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=err>…</span><span class=p>)</span><span class=o>.</span>
<span class=w>        </span><span class=p>},</span>
<span class=w>    </span><span class=p>)</span>
<span class=p>])</span>
</code></pre></div><p>And in the JavaScript code itself we can access the data using:<div class=chl><pre><span></span><code>let el = document.querySelector("[data-admin-ordering]"),
    ctx = JSON.parse(el.dataset.adminOrdering)
</code></pre></div><p>The django-js-asset package is available on <a href=https://github.com/matthiask/django-js-asset/>Github</a> and <a href=https://pypi.python.org/pypi/django-js-asset>PyPI</a>.<p>(Updated in August 2017 to avoid using internal API of <code>forms.Media</code> which will be removed in Django 2.0.)</div></div></main><footer><div class=wrappy><p><small> I like feedback! <a href="mailto:mk@406.ch?subject=Django admin apps and Content Security Policy compliance">Send me an email.</a> <br> <a rel="noopener noreferrer"href=https://ko-fi.com/matthiask target=_blank>☕ Buy me a coffee?</a> <br> Published on 2017-06-11 in <a href=/writing/category-django/>Django</a>, <a href=/writing/category-programming/>Programming</a> </small></p><script async crossorigin issue-term=pathname repo=matthiask/406-comments src=https://utteranc.es/client.js theme=github-light></script></div></footer>