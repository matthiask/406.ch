<!doctype html><html lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><title>Generating XLSX (or CSV) from the Django admin (or elsewhere) - Matthias Kestenholz</title><link href=/styles.7a4c5338b9f2.css rel=stylesheet><link title="Blog feed" href=/writing/atom.xml rel=alternate type=application/atom+xml><body><header><div class=wrappy><a class=title href=/>Hi, I'm Matthias</a><p class=subtitle>I am a founding partner of <a href=https://feinheit.ch>Feinheit AG</a> and <a href=https://diebruchpiloten.com>Die Bruchpiloten AG</a>. Find me on <a href=https://github.com/matthiask/>GitHub</a>, <a href=https://hachyderm.io/@matthiask rel=me>Mastodon</a>, <a href=https://bsky.app/profile/matthiask.406.ch rel=me>Bluesky</a>, <a rel="noopener noreferrer" title="if you must" href=https://www.linkedin.com/in/matthiaskestenholz target=_blank>LinkedIn</a> or by <a href=mailto:mk@406.ch>email</a>.<nav><a href=/writing/category-climate/>Climate</a><a href=/writing/category-django/>Django</a><a href=/writing/category-feincms/>feincms</a><a href=/writing/category-feincms3/>feincms3</a><a href=/writing/category-politik/>Politik</a><a href=/writing/category-programming/>Programming</a><a href=/writing/category-python/>Python</a><a href=/writing/category-til/>TIL</a><a href=/writing/category-weeknotes/>Weeknotes</a></nav></div></header><main><div class=wrappy><div class=text><small>2022-08-17 </small><h1 id=generating-xlsx-or-csv-from-the-django-admin-or-elsewhere><a class=toclink href=#generating-xlsx-or-csv-from-the-django-admin-or-elsewhere>Generating XLSX (or CSV) from the Django admin (or elsewhere)</a></h1><p>The blog post <a href=https://reinout.vanrees.org/weblog/2022/08/15/excel-instead-of-csv.html>Django: excel output instead of csv</a> inspired me to write about my own experience with XLSX or CSV generation.<h2 id=xlsx-export><a class=toclink href=#xlsx-export>XLSX export</a></h2><p>For a long time I used similarly structured ad-hoc code built on <a href=https://pypi.org/project/xlwt/>xlwt</a>, a project which looks abandoned these days. I have been a more or less happy user of <a href=https://pypi.org/project/openpyxl/>openpyxl</a> during the last years and intend to continue using it.<p>Something which I (or rather my users) require often is a way to export a list of selected objects from the Django admin. A good way to achieve this is by using an <a href=https://docs.djangoproject.com/en/4.1/ref/contrib/admin/actions/>admin action</a>. The common use case is that I have to export all model fields and maybe some additional data. <a href=https://github.com/matthiask/xlsxdocument/>xlsxdocument</a> makes this very easy, all you have to do is:<div class=chl><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>django.contrib</span><span class=w> </span><span class=kn>import</span> <span class=n>admin</span>
<span class=kn>from</span><span class=w> </span><span class=nn>xlsxdocument</span><span class=w> </span><span class=kn>import</span> <span class=n>export_selected</span>
<span class=kn>from</span><span class=w> </span><span class=nn>app</span><span class=w> </span><span class=kn>import</span> <span class=n>models</span>

<span class=nd>@admin</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>models</span><span class=o>.</span><span class=n>Example</span><span class=p>)</span>
<span class=k>class</span><span class=w> </span><span class=nc>ExampleAdmin</span><span class=p>(</span><span class=n>admin</span><span class=o>.</span><span class=n>ModelAdmin</span><span class=p>):</span>
    <span class=n>actions</span> <span class=o>=</span> <span class=p>[</span><span class=n>export_selected</span><span class=p>]</span>
</code></pre></div><p>If you wanted more control and wanted to add an additional field at the end you could write your own view (or embed the code in your own action, see the Django docs for this):<div class=chl><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>xlsxdocument</span><span class=w> </span><span class=kn>import</span> <span class=n>export_selected</span>
<span class=kn>from</span><span class=w> </span><span class=nn>app.models</span><span class=w> </span><span class=kn>import</span> <span class=n>Example</span>

<span class=k>def</span><span class=w> </span><span class=nf>generate_xlsx</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
    <span class=n>xlsx</span> <span class=o>=</span> <span class=n>XLSXDocument</span><span class=p>()</span>
    <span class=n>xlsx</span><span class=o>.</span><span class=n>table_from_queryset</span><span class=p>(</span>
        <span class=n>Example</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>all</span><span class=p>(),</span>
        <span class=n>additional</span><span class=o>=</span><span class=p>[</span>
            <span class=p>(</span><span class=s2>"URL"</span><span class=p>,</span> <span class=k>lambda</span> <span class=n>obj</span><span class=p>:</span> <span class=n>request</span><span class=o>.</span><span class=n>build_absolute_uri</span><span class=p>(</span><span class=n>obj</span><span class=o>.</span><span class=n>get_absolute_url</span><span class=p>())),</span>
        <span class=p>],</span>
    <span class=p>)</span>
    <span class=k>return</span> <span class=n>xlsx</span><span class=o>.</span><span class=n>to_response</span><span class=p>(</span><span class=s2>"example.xlsx"</span><span class=p>)</span>
</code></pre></div><p>Or, you could go even lower and use <code>xlsx.add_sheet()</code> and <code>xlsx.table()</code> yourself.<p>Dates, datetimes, numbers, choice fields and Django model instances are (I hope!) handled in a good way automatically.<h2 id=csv-export-for-large-datasets><a class=toclink href=#csv-export-for-large-datasets>CSV export for large datasets</a></h2><p>For large datasets the xlsxdocument/openpyxl combination has proven to be too slow. I didnâ€™t take the time to profile things to find where all the time is spent. Instead, I stumbled over a very relevant section in the Django documentation: <a href=https://docs.djangoproject.com/en/4.1/howto/outputting-csv/#streaming-large-csv-files>Streaming large CSV files</a> The code in there proved to be at least an order of magnitude faster (exports which produced server timeouts each time finished in a fraction of a second)<p>But, since I didnâ€™t want to go back to copy-pasting code and since I also didnâ€™t want to lose the automatic queryset handling I just had to write another library ðŸ˜… The result of this work is <a href=https://github.com/matthiask/django-fast-export/>django-fast-export</a>. Replicating the example from above (with the additional benefit of using a streaming response instead of building everything up-front) would look like this:<div class=chl><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>django_fast_export</span><span class=w> </span><span class=kn>import</span> <span class=n>StreamingCSVResponse</span><span class=p>,</span> <span class=n>all_values</span><span class=p>,</span> <span class=n>all_verbose_names</span>
<span class=kn>from</span><span class=w> </span><span class=nn>app.models</span><span class=w> </span><span class=kn>import</span> <span class=n>Example</span>

<span class=k>def</span><span class=w> </span><span class=nf>generate_csv</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
    <span class=k>def</span><span class=w> </span><span class=nf>_gen</span><span class=p>():</span>
        <span class=n>queryset</span> <span class=o>=</span> <span class=n>Example</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
        <span class=k>yield</span> <span class=p>(</span><span class=n>all_verbose_names</span><span class=p>(</span><span class=n>Example</span><span class=p>)</span> <span class=o>+</span> <span class=p>[</span><span class=s2>"URL"</span><span class=p>])</span>
        <span class=k>yield from</span> <span class=p>(</span>
            <span class=p>(</span><span class=n>all_values</span><span class=p>(</span><span class=n>instance</span><span class=p>)</span> <span class=o>+</span> <span class=p>[</span><span class=n>request</span><span class=o>.</span><span class=n>build_absolute_uri</span><span class=p>(</span><span class=n>instance</span><span class=o>.</span><span class=n>get_absolute_url</span><span class=p>())])</span>
            <span class=k>for</span> <span class=n>instance</span> <span class=ow>in</span> <span class=n>queryset</span>
        <span class=p>)</span>

    <span class=k>return</span> <span class=n>StreamingCSVResponse</span><span class=p>(</span><span class=n>_gen</span><span class=p>())</span>
</code></pre></div><h2 id=links><a class=toclink href=#links>Links</a></h2><ul><li><a href=https://github.com/matthiask/xlsxdocument/>xlsxdocument</a><li><a href=https://github.com/matthiask/django-fast-export/>django-fast-export</a></ul></div><div class="text prevnext"><a href=/writing/configuring-django-backends-using-speckenvs-12factor-support/>Previous post</a><a href=/writing/recent-objects-using-several-django-models/>Next post</a></div></div></main><footer><div class=wrappy><p><small> I like feedback! <a href="mailto:mk@406.ch?subject=Generating XLSX (or CSV) from the Django admin (or elsewhere)">Send me an email.</a> <br> <a rel="noopener noreferrer" href=https://ko-fi.com/matthiask target=_blank>â˜• Buy me a coffee?</a> <br> Published on 2022-08-17 in <a href=/writing/category-django/>Django</a>, <a href=/writing/category-programming/>Programming</a> </small></p><script async crossorigin issue-term=pathname repo=matthiask/406-comments src=https://utteranc.es/client.js theme=github-dark></script></div></footer>