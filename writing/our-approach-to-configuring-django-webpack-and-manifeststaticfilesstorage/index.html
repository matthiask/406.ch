<!doctypehtml><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0 name=viewport><title>Our approach to configuring Django, Webpack and ManifestStaticFilesStorage - Matthias Kestenholz</title><link href=/styles.e1e3d0e38f27.css rel=stylesheet><link title="Blog feed"href=/writing/atom.xml rel=alternate type=application/atom+xml><body><header><div class=wrappy><a class=back href=/>Back to the overview</a></div></header><main><div class=wrappy><div class=text><h1>Our approach to configuring Django, Webpack and ManifestStaticFilesStorage</h1><p>I spent some time finding out how <a href=https://www.djangoproject.com/>Django</a> and <a href=https://webpack.js.org/>webpack</a> should be configured so that they work well together both in development and in production. <a href=https://feinheit.ch/>We</a> are now using this setup on dozens of websites, so now is a good time to write down the approach.<p>Requirements for development were:<ul><li>Hot module reloading (especially of CSS, but also of JavaScript code).<li>Ability to use SCSS, ES6 and ES7.<li>PostCSS support (although I currently only use the autoprefixer, nothing else).</ul><p>Requirements for production:<ul><li>Filenames depending on the content of assets, so that we can add far future expiry headers without worrying about cache busting, and not only for webpack-generated assets but also for everything else, so <a href=https://docs.djangoproject.com/en/2.0/ref/contrib/staticfiles/#django.contrib.staticfiles.storage.ManifestStaticFilesStorage>ManifestStaticFilesStorage</a> is a must.<li>Separate delivery of CSS and JavaScript code – we want to add CSS to the <code>&LThead></code>, and JavaScript at the end of the <code>&LTbody></code>.<li>Working webpack code splitting is a plus if possible.</ul><p>There are a few <strong>problems</strong> that have to be solved:<ol><li>Django has to know about asset URLs generated by webpack.<li>Some assets are used both in HTML and in CSS/JavaScript code, e.g. a logo image. The obvious way to be able to do both things is to add the logo image twice, but that’s not nice.</ol><p>The best way I found for solving 1. is <a href=https://github.com/ezhome/django-webpack-loader/>django-webpack-loader</a>. webpack (respectively <a href=https://github.com/ezhome/webpack-bundle-tracker>webpack-bundle-tracker</a>) generates a JSON file when compiling assets, which can be read by the Django site to determine the <code>publicPath</code> of webpack bundles.<p>The following <code>webpack.config.js</code> snippet helps solve 2. It is by no means complete – uninteresting parts and development settings have been removed.<pre><code>/* global __dirname, process */
var path = require('path')
var webpack = require('webpack')
var BundleTracker = require('webpack-bundle-tracker')

module.exports = {
  context: path.join(__dirname, 'app', 'static', 'app'),
  entry: {
    main: './main.js',
  },
  output: {
    path: path.resolve('./static/app/'),
    publicPath: '/static/app/',
    filename: '[name]-[chunkhash].js',
  },
  module: {
    rules: [
      {
        test: /\.jsx?$/,
        exclude: /node_modules/,
        use: [
          {
            loader: 'babel-loader',
            options: {},  // babel-preset-env etc...
          },
        ],
      },
      {
        test: /\.css$/,
        use: ExtractTextPlugin.extract({
          fallback: 'style-loader',
          use: 'css-loader',
        }),
      },
      {
        test: /\.(png|woff|woff2|svg|eot|ttf|gif|jpe?g)$/,
        use: [
          {
            loader: 'url-loader',
            options: {
              limit: 1000,
              // ManifestStaticFilesStorage reuse.
              name: '[path][name].[md5:hash:hex:12].[ext]',
            },
          },
        ],
      },
    ],
  },
  resolve: {
    extensions: ['.js', '.jsx'],
    modules: ['app/static/app/', 'node_modules'],
    alias: {},
  },
  plugins: [
    new ExtractTextPlugin({
      filename: '[name]-[contenthash].css',
      allChunks: true,
    }),
    new BundleTracker({
      filename: './static/webpack-stats-prod.json',
    }),
    new webpack.HashedModuleIdsPlugin(),
  ],
}
</code></pre><ul><li>Put this configuration into <code>webpack.config.js</code><li>Configure the <code>url-loader</code> to use the same naming schema <code>ManifestStaticFilesStorage</code> uses (see above)<li>Add a <code>app/static/app/main.js</code> entrypoint, and enjoy that <code>require('img/logo.png')</code> and <code>{% static 'app/img/logo.png' %}</code> generate the same URL.</ul></div></div></main><footer><div class=wrappy><p><small> I like feedback! <a href="mailto:mk@406.ch?subject=Our approach to configuring Django, Webpack and ManifestStaticFilesStorage">Send me an email.</a> <br> <a rel="noopener noreferrer"href=https://ko-fi.com/matthiask target=_blank>☕ Buy me a coffee?</a> <br> Published on 2018-04-10 in <a href=/writing/category-django/>Django</a>, <a href=/writing/category-programming/>Programming</a> </small></p><script async crossorigin issue-term=pathname repo=matthiask/406-comments src=https://utteranc.es/client.js theme=github-dark></script></div></footer>