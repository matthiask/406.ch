<!doctypehtml><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0 name=viewport><title>Our approach to configuring Django, Webpack and ManifestStaticFilesStorage - Matthias Kestenholz</title><link href=/styles.d2047758144a.css rel=stylesheet><link title="Blog feed"href=/writing/atom.xml rel=alternate type=application/atom+xml><body><header><div class=wrappy><a class=title href=/>Hi, I'm Matthias</a><p class=subtitle>I am a founding partner of <a href=https://feinheit.ch>Feinheit AG</a> and <a href=https://diebruchpiloten.com>Die Bruchpiloten AG</a>. Find me on <a href=https://github.com/matthiask/>GitHub</a>, <a href=https://hachyderm.io/@matthiask rel=me>Mastodon</a>, <a rel="noopener noreferrer"title="if you must"href=https://www.linkedin.com/in/matthiaskestenholz target=_blank>LinkedIn</a> or by <a href=mailto:mk@406.ch>email</a>.<nav><a href=/writing/category-climate/>Climate</a><a href=/writing/category-django/>Django</a><a href=/writing/category-feincms/>feincms</a><a href=/writing/category-politik/>Politik</a><a href=/writing/category-programming/>Programming</a><a href=/writing/category-python/>Python</a><a href=/writing/category-weeknotes/>Weeknotes</a></nav></div></header><main><div class=wrappy><div class=text><small>2018-04-10 </small><h1 id=our-approach-to-configuring-django-webpack-and-manifeststaticfilesstorage><a class=toclink href=#our-approach-to-configuring-django-webpack-and-manifeststaticfilesstorage>Our approach to configuring Django, Webpack and ManifestStaticFilesStorage</a></h1><p>I spent some time finding out how <a href=https://www.djangoproject.com/>Django</a> and <a href=https://webpack.js.org/>webpack</a> should be configured so that they work well together both in development and in production. <a href=https://feinheit.ch/>We</a> are now using this setup on dozens of websites, so now is a good time to write down the approach.<p>Requirements for development were:<ul><li>Hot module reloading (especially of CSS, but also of JavaScript code).<li>Ability to use SCSS, ES6 and ES7.<li>PostCSS support (although I currently only use the autoprefixer, nothing else).</ul><p>Requirements for production:<ul><li>Filenames depending on the content of assets, so that we can add far future expiry headers without worrying about cache busting, and not only for webpack-generated assets but also for everything else, so <a href=https://docs.djangoproject.com/en/2.0/ref/contrib/staticfiles/#django.contrib.staticfiles.storage.ManifestStaticFilesStorage>ManifestStaticFilesStorage</a> is a must.<li>Separate delivery of CSS and JavaScript code – we want to add CSS to the <code>&LThead></code>, and JavaScript at the end of the <code>&LTbody></code>.<li>Working webpack code splitting is a plus if possible.</ul><p>There are a few <strong>problems</strong> that have to be solved:<ol><li>Django has to know about asset URLs generated by webpack.<li>Some assets are used both in HTML and in CSS/JavaScript code, e.g. a logo image. The obvious way to be able to do both things is to add the logo image twice, but that’s not nice.</ol><p>The best way I found for solving 1. is <a href=https://github.com/ezhome/django-webpack-loader/>django-webpack-loader</a>. webpack (respectively <a href=https://github.com/ezhome/webpack-bundle-tracker>webpack-bundle-tracker</a>) generates a JSON file when compiling assets, which can be read by the Django site to determine the <code>publicPath</code> of webpack bundles.<p>The following <code>webpack.config.js</code> snippet helps solve 2. It is by no means complete – uninteresting parts and development settings have been removed.<div class=chl><pre><span></span><code><span class=o>/*</span><span class=w> </span><span class=n>global</span><span class=w> </span><span class=n>__dirname</span><span class=p>,</span><span class=w> </span><span class=n>process</span><span class=w> </span><span class=o>*/</span>
<span class=k>var</span><span class=w> </span><span class=n>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>require</span><span class=p>(</span><span class=s1>'path'</span><span class=p>)</span>
<span class=k>var</span><span class=w> </span><span class=n>webpack</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>require</span><span class=p>(</span><span class=s1>'webpack'</span><span class=p>)</span>
<span class=k>var</span><span class=w> </span><span class=n>BundleTracker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>require</span><span class=p>(</span><span class=s1>'webpack-bundle-tracker'</span><span class=p>)</span>

<span class=n>module</span><span class=o>.</span><span class=n>exports</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=n>context</span><span class=p>:</span><span class=w> </span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>__dirname</span><span class=p>,</span><span class=w> </span><span class=s1>'app'</span><span class=p>,</span><span class=w> </span><span class=s1>'static'</span><span class=p>,</span><span class=w> </span><span class=s1>'app'</span><span class=p>),</span>
<span class=w>  </span><span class=n>entry</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>main</span><span class=p>:</span><span class=w> </span><span class=s1>'./main.js'</span><span class=p>,</span>
<span class=w>  </span><span class=p>},</span>
<span class=w>  </span><span class=n>output</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>path</span><span class=p>:</span><span class=w> </span><span class=n>path</span><span class=o>.</span><span class=n>resolve</span><span class=p>(</span><span class=s1>'./static/app/'</span><span class=p>),</span>
<span class=w>    </span><span class=n>publicPath</span><span class=p>:</span><span class=w> </span><span class=s1>'/static/app/'</span><span class=p>,</span>
<span class=w>    </span><span class=n>filename</span><span class=p>:</span><span class=w> </span><span class=s1>'[name]-[chunkhash].js'</span><span class=p>,</span>
<span class=w>  </span><span class=p>},</span>
<span class=w>  </span><span class=n>module</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>rules</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<span class=w>      </span><span class=p>{</span>
<span class=w>        </span><span class=n>test</span><span class=p>:</span><span class=w> </span><span class=o>/</span>\<span class=o>.</span><span class=n>jsx</span><span class=err>?</span><span class=o>$/</span><span class=p>,</span>
<span class=w>        </span><span class=n>exclude</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>node_modules</span><span class=o>/</span><span class=p>,</span>
<span class=w>        </span><span class=n>use</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<span class=w>          </span><span class=p>{</span>
<span class=w>            </span><span class=n>loader</span><span class=p>:</span><span class=w> </span><span class=s1>'babel-loader'</span><span class=p>,</span>
<span class=w>            </span><span class=n>options</span><span class=p>:</span><span class=w> </span><span class=p>{},</span><span class=w>  </span><span class=o>//</span><span class=w> </span><span class=n>babel</span><span class=o>-</span><span class=n>preset</span><span class=o>-</span><span class=n>env</span><span class=w> </span><span class=n>etc</span><span class=o>...</span>
<span class=w>          </span><span class=p>},</span>
<span class=w>        </span><span class=p>],</span>
<span class=w>      </span><span class=p>},</span>
<span class=w>      </span><span class=p>{</span>
<span class=w>        </span><span class=n>test</span><span class=p>:</span><span class=w> </span><span class=o>/</span>\<span class=o>.</span><span class=n>css</span><span class=o>$/</span><span class=p>,</span>
<span class=w>        </span><span class=n>use</span><span class=p>:</span><span class=w> </span><span class=n>ExtractTextPlugin</span><span class=o>.</span><span class=n>extract</span><span class=p>({</span>
<span class=w>          </span><span class=n>fallback</span><span class=p>:</span><span class=w> </span><span class=s1>'style-loader'</span><span class=p>,</span>
<span class=w>          </span><span class=n>use</span><span class=p>:</span><span class=w> </span><span class=s1>'css-loader'</span><span class=p>,</span>
<span class=w>        </span><span class=p>}),</span>
<span class=w>      </span><span class=p>},</span>
<span class=w>      </span><span class=p>{</span>
<span class=w>        </span><span class=n>test</span><span class=p>:</span><span class=w> </span><span class=o>/</span>\<span class=o>.</span><span class=p>(</span><span class=n>png</span><span class=o>|</span><span class=n>woff</span><span class=o>|</span><span class=n>woff2</span><span class=o>|</span><span class=n>svg</span><span class=o>|</span><span class=n>eot</span><span class=o>|</span><span class=n>ttf</span><span class=o>|</span><span class=n>gif</span><span class=o>|</span><span class=n>jpe</span><span class=err>?</span><span class=n>g</span><span class=p>)</span><span class=o>$/</span><span class=p>,</span>
<span class=w>        </span><span class=n>use</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<span class=w>          </span><span class=p>{</span>
<span class=w>            </span><span class=n>loader</span><span class=p>:</span><span class=w> </span><span class=s1>'url-loader'</span><span class=p>,</span>
<span class=w>            </span><span class=n>options</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>              </span><span class=n>limit</span><span class=p>:</span><span class=w> </span><span class=mi>1000</span><span class=p>,</span>
<span class=w>              </span><span class=o>//</span><span class=w> </span><span class=n>ManifestStaticFilesStorage</span><span class=w> </span><span class=n>reuse</span><span class=o>.</span>
<span class=w>              </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=s1>'[path][name].[md5:hash:hex:12].[ext]'</span><span class=p>,</span>
<span class=w>            </span><span class=p>},</span>
<span class=w>          </span><span class=p>},</span>
<span class=w>        </span><span class=p>],</span>
<span class=w>      </span><span class=p>},</span>
<span class=w>    </span><span class=p>],</span>
<span class=w>  </span><span class=p>},</span>
<span class=w>  </span><span class=n>resolve</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>extensions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>'.js'</span><span class=p>,</span><span class=w> </span><span class=s1>'.jsx'</span><span class=p>],</span>
<span class=w>    </span><span class=n>modules</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>'app/static/app/'</span><span class=p>,</span><span class=w> </span><span class=s1>'node_modules'</span><span class=p>],</span>
<span class=w>    </span><span class=n>alias</span><span class=p>:</span><span class=w> </span><span class=p>{},</span>
<span class=w>  </span><span class=p>},</span>
<span class=w>  </span><span class=n>plugins</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
<span class=w>    </span><span class=n>new</span><span class=w> </span><span class=n>ExtractTextPlugin</span><span class=p>({</span>
<span class=w>      </span><span class=n>filename</span><span class=p>:</span><span class=w> </span><span class=s1>'[name]-[contenthash].css'</span><span class=p>,</span>
<span class=w>      </span><span class=n>allChunks</span><span class=p>:</span><span class=w> </span><span class=bp>true</span><span class=p>,</span>
<span class=w>    </span><span class=p>}),</span>
<span class=w>    </span><span class=n>new</span><span class=w> </span><span class=n>BundleTracker</span><span class=p>({</span>
<span class=w>      </span><span class=n>filename</span><span class=p>:</span><span class=w> </span><span class=s1>'./static/webpack-stats-prod.json'</span><span class=p>,</span>
<span class=w>    </span><span class=p>}),</span>
<span class=w>    </span><span class=n>new</span><span class=w> </span><span class=n>webpack</span><span class=o>.</span><span class=n>HashedModuleIdsPlugin</span><span class=p>(),</span>
<span class=w>  </span><span class=p>],</span>
<span class=p>}</span>
</code></pre></div><ul><li>Put this configuration into <code>webpack.config.js</code><li>Configure the <code>url-loader</code> to use the same naming schema <code>ManifestStaticFilesStorage</code> uses (see above)<li>Add a <code>app/static/app/main.js</code> entrypoint, and enjoy that <code>require('img/logo.png')</code> and <code>{% static 'app/img/logo.png' %}</code> generate the same URL.</ul></div></div></main><footer><div class=wrappy><p><small> I like feedback! <a href="mailto:mk@406.ch?subject=Our approach to configuring Django, Webpack and ManifestStaticFilesStorage">Send me an email.</a> <br> <a rel="noopener noreferrer"href=https://ko-fi.com/matthiask target=_blank>☕ Buy me a coffee?</a> <br> Published on 2018-04-10 in <a href=/writing/category-django/>Django</a>, <a href=/writing/category-programming/>Programming</a> </small></p><script async crossorigin issue-term=pathname repo=matthiask/406-comments src=https://utteranc.es/client.js theme=github-light></script></div></footer>